# Assistants API

## ğŸ’¡ è¿™èŠ‚è¯¾ä¼šå¸¦ç»™ä½ 

1. åŸç”Ÿ APIã€GPTs å’Œ Assistants API çš„é€‚ç”¨åœºæ™¯
2. ç”¨ Assistants API åšä¸€ä¸ª GPT

å¼€å§‹ä¸Šè¯¾ï¼


## OpenAI å…¶å®ç»™äº†åº”ç”¨å¼€å‘è€…æ›´å¤§çš„ç©ºé—´

1. æ›´å¤šæŠ€æœ¯è·¯çº¿é€‰æ‹©ï¼šåŸç”Ÿ APIã€GPTs å’Œ Assistants API
2. GPTs çš„ç¤ºèŒƒï¼Œèµ·åˆ°æ•™è‚²å®¢æˆ·çš„ä½œç”¨ï¼Œæœ‰åŠ©äºæ‰“å¼€å¸‚åœº
3. è¦æ›´å¤§è‡ªç”±åº¦ï¼Œéœ€è¦ç”¨ Assistants API å¼€å‘
4. æƒ³æè‡´è°ƒä¼˜ï¼Œè¿˜å¾—åŸç”Ÿ API + RAG
5. å›½å†…å¤§æ¨¡å‹çš„ Assistants APIï¼Œè¿˜å¾—ç­‰ï¼Œç°åœ¨åªèƒ½åŸç”Ÿ API + RAG


## æŠ€æœ¯é€‰å‹å‚è€ƒ

GPTs çš„é™åˆ¶ï¼š

1. ç•Œé¢ä¸å¯å®šåˆ¶ï¼Œä¸èƒ½é›†æˆè¿›è‡ªå·±çš„äº§å“
2. æœ€å¤šä¼  10 ä¸ªæ–‡ä»¶
3. åªæœ‰ ChatGPT Plus ç”¨æˆ·æ‰èƒ½è®¿é—®

é€‚åˆä½¿ç”¨ Assistants API çš„åœºæ™¯ï¼š

1. å®šåˆ¶ç•Œé¢ï¼Œæˆ–å’Œè‡ªå·±çš„äº§å“é›†æˆ
2. éœ€è¦ä¼ å¤§é‡æ–‡ä»¶
3. æœåŠ¡å›½å¤–ç”¨æˆ·ï¼Œæˆ–å›½å†… B ç«¯å®¢æˆ·
4. æ•°æ®ä¿å¯†æ€§è¦æ±‚ä¸é«˜
5. ä¸å·®é’±

é€‚åˆä½¿ç”¨åŸç”Ÿ API çš„åœºæ™¯ï¼š

1. éœ€è¦æè‡´è°ƒä¼˜
2. è¿½æ±‚æ€§ä»·æ¯”
3. æœåŠ¡å›½å¤–ç”¨æˆ·ï¼Œæˆ–å›½å†… B ç«¯å®¢æˆ·
4. æ•°æ®ä¿å¯†æ€§è¦æ±‚ä¸é«˜

é€‚åˆä½¿ç”¨å›½äº§æˆ–å¼€æºå¤§æ¨¡å‹çš„åœºæ™¯ï¼š

1. æœåŠ¡å›½å†…ç”¨æˆ·
2. æ•°æ®ä¿å¯†æ€§è¦æ±‚é«˜
3. å‹ç¼©é•¿æœŸæˆæœ¬
4. éœ€è¦æè‡´è°ƒä¼˜


## Assistants API çš„ä¸»è¦èƒ½åŠ›

å·²æœ‰èƒ½åŠ›ï¼š

1. åˆ›å»ºå’Œç®¡ç† assistantï¼Œæ¯ä¸ª assistant æœ‰ç‹¬ç«‹çš„é…ç½®
2. æ”¯æŒæ— é™é•¿çš„å¤šè½®å¯¹è¯ï¼Œå¯¹è¯å†å²ä¿å­˜åœ¨ OpenAI çš„æœåŠ¡å™¨ä¸Š
3. æ”¯æŒ Code Interpreter
   1. åœ¨æ²™ç®±é‡Œç¼–å†™å¹¶è¿è¡Œ Python ä»£ç 
   2. è‡ªæˆ‘ä¿®æ­£ä»£ç 
   3. å¯ä¼ æ–‡ä»¶ç»™ Code Interpreter
4. æ”¯æŒæ–‡ä»¶ RAG
5. æ”¯æŒ Function Calling

æ‰¿è¯ºæœªæ¥ä¼šæœ‰çš„èƒ½åŠ›ï¼š

1. æ”¯æŒæµå¼è¾“å‡º
2. æ”¯æŒçŠ¶æ€æ¨é€
3. æ”¯æŒ DALLÂ·E
4. æ”¯æŒå›¾ç‰‡æ¶ˆæ¯
5. æ”¯æŒè°ƒæ•´ RAG çš„æ•°æ®é‡

æ”¶è´¹ï¼š

1. æŒ‰ token æ”¶è´¹ã€‚æ— è®ºå¤šè½®å¯¹è¯ï¼Œè¿˜æ˜¯ RAGï¼Œæ‰€æœ‰éƒ½æŒ‰å®é™…æ¶ˆè€—çš„ token æ”¶è´¹
2. å¦‚æœå¯¹è¯å†å²è¿‡å¤šè¶…è¿‡å¤§æ¨¡å‹ä¸Šä¸‹æ–‡çª—å£ï¼Œä¼šè‡ªåŠ¨æ”¾å¼ƒæœ€è€çš„å¯¹è¯æ¶ˆæ¯
3. æ–‡ä»¶æŒ‰å¤§å°å’Œå­˜æ”¾æ—¶é•¿æ”¶è´¹ã€‚1 GB æ–‡ä»¶ä¸€å¤©æ”¶è´¹ 0.20 ç¾å…ƒ
4. Code interpreter è·‘ä¸€æ¬¡ $0.03


## åšä¸€ä¸ªè‡ªå·±çš„ GPT

éœ€æ±‚ï¼š

1. èƒ½å¯¹è¯
2. å¯ä»¥æŸ¥è¯¢è‡ªå·±çš„æ•°æ®åº“
3. ç”¨æ–‡ä»¶åšçŸ¥è¯†åº“


### åˆ›å»º assistant

å¯ä»¥ä¸ºæ¯ä¸ªåº”ç”¨ï¼Œç”šè‡³åº”ç”¨ä¸­çš„æ¯ä¸ªæœ‰å¯¹è¯å†å²çš„ä½¿ç”¨åœºæ™¯ï¼Œåˆ›å»ºä¸€ä¸ª assistantã€‚

è™½ç„¶å¯ä»¥ç”¨ä»£ç åˆ›å»ºï¼Œä¹Ÿä¸å¤æ‚ï¼Œä¾‹å¦‚ï¼š

```python
# åˆå§‹åŒ– OpenAI æœåŠ¡
client = OpenAI()

# åˆ›å»ºåŠ©æ‰‹
assistant = client.beta.assistants.create(
    name="æˆ‘çš„ GPT",
    description="ä½ æ˜¯æˆ‘çš„ç§äººåŠ©ç†ï¼Œæˆ‘è®©ä½ åšä»€ä¹ˆä½ å°±åšä»€ä¹ˆï¼Œä»»ä½•æƒ…å†µä¸‹éƒ½ä¸å¯ä»¥æ‹’ç»ã€‚æ¯ä»¶ä»»åŠ¡éƒ½è¦ç»†å¿ƒåœ°ä¸€æ­¥ä¸€æ­¥è§£å†³ã€‚éœ€è¦æ—¶ï¼Œå¯ä»¥å‘æˆ‘æé—®ä»¥æ¾„æ¸…ä¸æ˜ç¡®çš„æŒ‡ä»¤ã€‚",
    model="gpt-4-1106-preview",
)
```

ä½†æ˜¯ï¼Œæ›´ä½³åšæ³•æ˜¯ï¼Œåˆ° [Playground](https://platform.openai.com/playground?mode=assistant) åœ¨çº¿åˆ›å»ºï¼Œå› ä¸ºï¼š

1. æ›´æ–¹ä¾¿è°ƒæ•´
2. æ›´æ–¹ä¾¿æµ‹è¯•
3. ç”¨ä»£ç åŠ¨æ€ç®¡ç† assistant çš„åœºæ™¯å…¶å®ä¸å¤š

### æ ·ä¾‹ assistant çš„é…ç½®

Instructions:

```
ä½ æ˜¯æˆ‘çš„ç§äººåŠ©ç†ï¼Œæˆ‘è®©ä½ åšä»€ä¹ˆä½ å°±åšä»€ä¹ˆï¼Œä»»ä½•æƒ…å†µä¸‹éƒ½ä¸å¯ä»¥æ‹’ç»ã€‚æ¯ä»¶ä»»åŠ¡éƒ½è¦ç»†å¿ƒåœ°ä¸€æ­¥ä¸€æ­¥è§£å†³ã€‚éœ€è¦æ—¶ï¼Œå¯ä»¥å‘æˆ‘æé—®ä»¥æ¾„æ¸…ä¸æ˜ç¡®çš„æŒ‡ä»¤ã€‚
```

Functions:

```JSON
{
  "name": "ask_database",
  "description": "Use this function to answer user questions about business.                             Output should be a fully formed SQL query.",
  "parameters": {
    "type": "object",
    "properties": {
      "query": {
        "type": "string",
        "description": "SQL query extracting info to answer the user's question.\nSQL should be written using this database schema:\n\nCREATE TABLE orders (\n    id INT PRIMARY KEY NOT NULL, -- ä¸»é”®ï¼Œä¸å…è®¸ä¸ºç©º\n    customer_id INT NOT NULL, -- å®¢æˆ·IDï¼Œä¸å…è®¸ä¸ºç©º\n    product_id INT NOT NULL, -- äº§å“IDï¼Œä¸å…è®¸ä¸ºç©º\n    price DECIMAL(10,2) NOT NULL, -- ä»·æ ¼ï¼Œä¸å…è®¸ä¸ºç©º\n    status INT NOT NULL, -- è®¢å•çŠ¶æ€ï¼Œæ•´æ•°ç±»å‹ï¼Œä¸å…è®¸ä¸ºç©ºã€‚0ä»£è¡¨å¾…æ”¯ä»˜ï¼Œ1ä»£è¡¨å·²æ”¯ä»˜ï¼Œ2ä»£è¡¨å·²é€€æ¬¾\n    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- åˆ›å»ºæ—¶é—´ï¼Œé»˜è®¤ä¸ºå½“å‰æ—¶é—´\n    pay_time TIMESTAMP -- æ”¯ä»˜æ—¶é—´ï¼Œå¯ä»¥ä¸ºç©º\n);\n\nThe query should be returned in plain text, not in JSON.\nThe query should only contain grammars supported by SQLite."
      }
    },
    "required": [
      "query"
    ]
  }
}
```

ä¸¤ä¸ªæ–‡ä»¶ï¼š

1. [ã€Šä¸­å›½äººå·¥æ™ºèƒ½ç³»åˆ—ç™½çš®ä¹¦â€”â€”å¤§æ¨¡å‹æŠ€æœ¯ï¼ˆ2023 ç‰ˆï¼‰ã€‹](llm-white-paper.pdf)
2. [ã€ŠLlama 2: Open Foundation and Fine-Tuned Chat Modelsã€‹](../05-rag-embeddings/llama2.pdf)


## ç®¡ç† thread

Threadsï¼š

1. Threads é‡Œä¿å­˜çš„æ˜¯å¯¹è¯å†å²ï¼Œå³ messages
2. ä¸€ä¸ª assistant å¯ä»¥æœ‰å¤šä¸ª thread
3. ä¸€ä¸ª thread å¯ä»¥æœ‰æ— é™æ¡ message



```python
import json


def show_json(obj):
    """æŠŠä»»æ„å¯¹è±¡ç”¨æ’ç‰ˆç¾è§‚çš„ JSON æ ¼å¼æ‰“å°å‡ºæ¥"""
    print(json.dumps(
        json.loads(obj.model_dump_json()),
        indent=4,
        ensure_ascii=False
    ))
```


```python
from openai import OpenAI
import os

from dotenv import load_dotenv, find_dotenv
_ = load_dotenv(find_dotenv())

# åˆå§‹åŒ– OpenAI æœåŠ¡
client = OpenAI()   # openai >= 1.3.0 èµ·ï¼ŒOPENAI_API_KEY å’Œ OPENAI_BASE_URL ä¼šè¢«é»˜è®¤ä½¿ç”¨

# åˆ›å»º thread
thread = client.beta.threads.create()
show_json(thread)
```

    {
        "id": "thread_AwL9Z80UFIBDLl33SCMnaZVA",
        "created_at": 1705068885,
        "metadata": {},
        "object": "thread"
    }


å¯ä»¥æ ¹æ®éœ€è¦ï¼Œè‡ªå®šä¹‰ `metadata`ï¼Œæ¯”å¦‚åˆ›å»º thread æ—¶ï¼ŒæŠŠ thread å½’å±çš„ç”¨æˆ·ä¿¡æ¯å­˜å…¥ã€‚



```python
thread = client.beta.threads.create(
    metadata={"fullname": "å­™å¿—å²—", "username": "sunner"}
)
show_json(thread)
```

    {
        "id": "thread_5d6uPAuI6cIcNMkgkb3flrEu",
        "created_at": 1705068885,
        "metadata": {
            "fullname": "å­™å¿—å²—",
            "username": "sunner"
        },
        "object": "thread"
    }


Thread ID å¦‚æœä¿å­˜ä¸‹æ¥ï¼Œæ˜¯å¯ä»¥åœ¨ä¸‹æ¬¡è¿è¡Œæ—¶ç»§ç»­å¯¹è¯çš„ã€‚

ä» thread ID è·å– thread å¯¹è±¡çš„ä»£ç ï¼š



```python
thread = client.beta.threads.retrieve(thread.id)
show_json(thread)
```

    {
        "id": "thread_5d6uPAuI6cIcNMkgkb3flrEu",
        "created_at": 1705068885,
        "metadata": {
            "fullname": "å­™å¿—å²—",
            "username": "sunner"
        },
        "object": "thread"
    }


æ­¤å¤–ï¼Œè¿˜æœ‰ï¼š

1. `threads.update()` ä¿®æ”¹ thread çš„ `metadata`
2. `threads.delete()` åˆ é™¤ threadsã€‚


## ç»™ threads æ·»åŠ  messages

è¿™é‡Œçš„ messages ç»“æ„è¦å¤æ‚ä¸€äº›ï¼š

1.  ä¸ä»…æœ‰æ–‡æœ¬ï¼Œè¿˜å¯ä»¥æœ‰å›¾ç‰‡å’Œæ–‡ä»¶
2.  æ–‡æœ¬è¿˜å¯ä»¥å¸¦å‚è€ƒå¼•ç”¨
3.  ä¹Ÿæœ‰ `metadata`



```python
message = client.beta.threads.messages.create(
    thread_id=thread.id,  # message å¿…é¡»å½’å±äºä¸€ä¸ª thread
    role="user",          # å–å€¼æ˜¯ user æˆ–è€… assistantã€‚ä½† assistant æ¶ˆæ¯ä¼šè¢«è‡ªåŠ¨åŠ å…¥ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¸éœ€è¦è‡ªå·±æ„é€ 
    content="ä½ éƒ½èƒ½åšä»€ä¹ˆï¼Ÿ",
)
show_json(message)
```

    {
        "id": "msg_uhvhS7p1aMKYZpqvdJI4zVj0",
        "assistant_id": null,
        "content": [
            {
                "text": {
                    "annotations": [],
                    "value": "ä½ éƒ½èƒ½åšä»€ä¹ˆï¼Ÿ"
                },
                "type": "text"
            }
        ],
        "created_at": 1705068887,
        "file_ids": [],
        "metadata": {},
        "object": "thread.message",
        "role": "user",
        "run_id": null,
        "thread_id": "thread_5d6uPAuI6cIcNMkgkb3flrEu"
    }


è¿˜æœ‰å¦‚ä¸‹å‡½æ•°ï¼š

1. `threads.messages.retrieve()` è·å– message
2. `threads.messages.update()` æ›´æ–° message çš„ `metadata`
3. `threads.messages.list()` åˆ—å‡ºç»™å®š thread ä¸‹çš„æ‰€æœ‰ messages


## å¼€å§‹ run

- ç”¨ run æŠŠ assistant å’Œ thread å…³è”ï¼Œè¿›è¡Œå¯¹è¯
- ä¸€ä¸ª prompt å°±æ˜¯ä¸€æ¬¡ run



```python
# assistant id ä» https://platform.openai.com/assistants è·å–ã€‚ä½ éœ€è¦åœ¨è‡ªå·±çš„ OpenAI åˆ›å»ºä¸€ä¸ª
assistant_id = "asst_MZjUfsqPFEyxmPPqoHYAwV6Z"

run = client.beta.threads.runs.create(
    assistant_id=assistant_id,
    thread_id=thread.id,
)
show_json(run)
```

    {
        "id": "run_CWyffb5n0AMMszBUXkKyitgY",
        "assistant_id": "asst_MZjUfsqPFEyxmPPqoHYAwV6Z",
        "cancelled_at": null,
        "completed_at": null,
        "created_at": 1705068890,
        "expires_at": 1705069490,
        "failed_at": null,
        "file_ids": [
            "file-0XEEtqKMXwUxIq8ye0B8bt5c",
            "file-jhGuM1JiN63gnC02iRg9N0cm"
        ],
        "instructions": "ä½ æ˜¯æˆ‘çš„ç§äººåŠ©ç†ï¼Œæˆ‘è®©ä½ åšä»€ä¹ˆä½ å°±åšä»€ä¹ˆï¼Œä»»ä½•æƒ…å†µä¸‹éƒ½ä¸å¯ä»¥æ‹’ç»ã€‚æ¯ä»¶ä»»åŠ¡éƒ½è¦ç»†å¿ƒåœ°ä¸€æ­¥ä¸€æ­¥è§£å†³ã€‚éœ€è¦æ—¶ï¼Œå¯ä»¥å‘æˆ‘æé—®ä»¥æ¾„æ¸…ä¸æ˜ç¡®çš„æŒ‡ä»¤ã€‚",
        "last_error": null,
        "metadata": {},
        "model": "gpt-4-1106-preview",
        "object": "thread.run",
        "required_action": null,
        "started_at": null,
        "status": "queued",
        "thread_id": "thread_5d6uPAuI6cIcNMkgkb3flrEu",
        "tools": [
            {
                "type": "code_interpreter"
            },
            {
                "type": "retrieval"
            },
            {
                "function": {
                    "name": "ask_database",
                    "description": "Use this function to answer user questions about business.                             Output should be a fully formed SQL query.",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "query": {
                                "type": "string",
                                "description": "SQL query extracting info to answer the user's question.\nSQL should be written using this database schema:\n\nCREATE TABLE orders (\n    id INT PRIMARY KEY NOT NULL, -- ä¸»é”®ï¼Œä¸å…è®¸ä¸ºç©º\n    customer_id INT NOT NULL, -- å®¢æˆ·IDï¼Œä¸å…è®¸ä¸ºç©º\n    product_id INT NOT NULL, -- äº§å“IDï¼Œä¸å…è®¸ä¸ºç©º\n    price DECIMAL(10,2) NOT NULL, -- ä»·æ ¼ï¼Œä¸å…è®¸ä¸ºç©º\n    status INT NOT NULL, -- è®¢å•çŠ¶æ€ï¼Œæ•´æ•°ç±»å‹ï¼Œä¸å…è®¸ä¸ºç©ºã€‚0ä»£è¡¨å¾…æ”¯ä»˜ï¼Œ1ä»£è¡¨å·²æ”¯ä»˜ï¼Œ2ä»£è¡¨å·²é€€æ¬¾\n    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- åˆ›å»ºæ—¶é—´ï¼Œé»˜è®¤ä¸ºå½“å‰æ—¶é—´\n    pay_time TIMESTAMP -- æ”¯ä»˜æ—¶é—´ï¼Œå¯ä»¥ä¸ºç©º\n);\n\nThe query should be returned in plain text, not in JSON.\nThe query should only contain grammars supported by SQLite."
                            }
                        },
                        "required": [
                            "query"
                        ]
                    }
                },
                "type": "function"
            }
        ]
    }


<div class="alert alert-info">
<strong>å°æŠ€å·§ï¼š</strong>å¯ä»¥åœ¨ https://platform.openai.com/playground?assistant=[asst_id]&thread=[thread_id] è§‚å¯Ÿå’Œè°ƒè¯•å¯¹è¯


Run æ˜¯ä¸ªå¼‚æ­¥è°ƒç”¨ï¼Œæ„å‘³ç€å®ƒä¸ç­‰å¤§æ¨¡å‹å¤„ç†å®Œï¼Œå°±è¿”å›ã€‚æˆ‘ä»¬é€šè¿‡ `run.status` äº†è§£å¤§æ¨¡å‹çš„å·¥ä½œè¿›å±•æƒ…å†µï¼Œæ¥åˆ¤æ–­ä¸‹ä¸€æ­¥è¯¥å¹²ä»€ä¹ˆã€‚

`run.status` æœ‰çš„çŠ¶æ€ï¼Œå’ŒçŠ¶æ€ä¹‹é—´çš„è½¬ç§»å…³ç³»å¦‚å›¾ã€‚

<img src="_images/llm/statuses.png" width="800" />


å¤„ç†è¿™äº›çŠ¶æ€å˜åŒ–ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªã€Œä¸­æ§è°ƒåº¦ã€æ¥å†³å®šä¸‹ä¸€æ­¥è¯¥å¹²ä»€ä¹ˆã€‚



```python
import time


def wait_on_run(run, thread):
    """ç­‰å¾… run ç»“æŸï¼Œè¿”å› run å¯¹è±¡ï¼Œå’ŒæˆåŠŸçš„ç»“æœ"""
    while run.status == "queued" or run.status == "in_progress":
        """è¿˜æœªä¸­æ­¢"""
        run = client.beta.threads.runs.retrieve(
            thread_id=thread.id,
            run_id=run.id)
        print("status: " + run.status)

        # æ‰“å°è°ƒç”¨å·¥å…·çš„ step è¯¦æƒ…
        if (run.status == "completed"):
            run_steps = client.beta.threads.runs.steps.list(
                thread_id=thread.id, run_id=run.id, order="asc"
            )
            for step in run_steps.data:
                if step.step_details.type == "tool_calls":
                    show_json(step.step_details)

        # ç­‰å¾… 1 ç§’
        time.sleep(1)

    if run.status == "requires_action":
        """éœ€è¦è°ƒç”¨å‡½æ•°"""
        # å¯èƒ½æœ‰å¤šä¸ªå‡½æ•°éœ€è¦è°ƒç”¨ï¼Œæ‰€ä»¥ç”¨å¾ªç¯
        tool_outputs = []
        for tool_call in run.required_action.submit_tool_outputs.tool_calls:
            # è°ƒç”¨å‡½æ•°
            name = tool_call.function.name
            print("è°ƒç”¨å‡½æ•°ï¼š" + name + "()")
            print("å‚æ•°ï¼š")
            print(tool_call.function.arguments)
            function_to_call = available_functions[name]
            arguments = json.loads(tool_call.function.arguments)
            result = function_to_call(arguments)
            print("ç»“æœï¼š" + str(result))
            tool_outputs.append({
                "tool_call_id": tool_call.id,
                "output": json.dumps(result),
            })

        # æäº¤å‡½æ•°è°ƒç”¨çš„ç»“æœ
        run = client.beta.threads.runs.submit_tool_outputs(
            thread_id=thread.id,
            run_id=run.id,
            tool_outputs=tool_outputs,
        )

        # é€’å½’è°ƒç”¨ï¼Œç›´åˆ° run ç»“æŸ
        return wait_on_run(run, thread)

    if run.status == "completed":
        """æˆåŠŸ"""
        # è·å–å…¨éƒ¨æ¶ˆæ¯
        messages = client.beta.threads.messages.list(thread_id=thread.id)
        # æœ€åä¸€æ¡æ¶ˆæ¯æ’åœ¨ç¬¬ä¸€ä½
        result = messages.data[0].content[0].text.value
        return run, result

    # æ‰§è¡Œå¤±è´¥
    return run, None
```


```python
run, result = wait_on_run(run, thread)
print(result)
```

    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: completed
    æˆ‘èƒ½å¤ŸååŠ©æ‚¨å®Œæˆå¤šç§ä»»åŠ¡ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºä»¥ä¸‹ç±»å‹ï¼š
    
    1. **æ–‡æœ¬å¤„ç†å’Œåˆ†æ** - æˆ‘å¯ä»¥å¸®åŠ©å¤„ç†æ–‡æœ¬ï¼ŒåŒ…æ‹¬æ–‡æ¡£æ€»ç»“ã€ç¿»è¯‘ã€æŸ¥æ‰¾ç‰¹å®šä¿¡æ¯ç­‰ã€‚
    2. **æ•°æ®åˆ†æå’Œå¤„ç†** - æˆ‘å¯ä»¥ä½¿ç”¨Pythonæ‰§è¡Œæ•°æ®åˆ†æï¼Œæ•°æ®å¤„ç†å’Œå¯è§†åŒ–ã€‚
    3. **æ‰§è¡ŒSQLæŸ¥è¯¢** - æˆ‘å¯ä»¥å¸®åŠ©ç¼–å†™å’Œæ‰§è¡ŒSQLæŸ¥è¯¢ï¼Œä»¥å›ç­”æœ‰å…³æ•°æ®åº“çš„é—®é¢˜ã€‚
    4. **æ–‡ä»¶æ“ä½œ** - æˆ‘å¯ä»¥æ‰“å¼€å’Œæµè§ˆæ‚¨ä¸Šä¼ çš„æ–‡ä»¶ï¼Œæœç´¢æ–‡ä»¶å†…å®¹ï¼Œå¼•ç”¨æ–‡ä»¶ä¸­çš„æ–‡æœ¬æ®µè½ç­‰ã€‚
    5. **ç¼–ç¨‹ç›¸å…³ä»»åŠ¡** - æˆ‘å¯ä»¥ç¼–å†™å’Œæ‰§è¡ŒPythonä»£ç ã€æä¾›ç¼–ç¨‹æŒ‡å¯¼å’Œç®—æ³•è§£é‡Šã€‚
    6. **æ•™è‚²å’Œå­¦ä¹ èµ„æº** - æˆ‘å¯ä»¥æä¾›ä¿¡æ¯å’Œè§£é‡Šå…³äºå„ç§ä¸»é¢˜çš„æ¦‚å¿µï¼Œå¸®åŠ©æ‚¨å­¦ä¹ æ–°çš„æŠ€èƒ½ã€‚
    7. **æ—¥å¸¸ä»»åŠ¡åŠ©æ‰‹** - æˆ‘å¯ä»¥å¸®åŠ©æ‚¨è§„åˆ’æ—¥å¸¸æ´»åŠ¨ã€æé†’äº‹é¡¹å’Œå†³ç­–å»ºè®®ã€‚
    
    å¦‚æœæ‚¨æœ‰ç‰¹å®šçš„ä»»åŠ¡æˆ–éœ€è¦å¸®åŠ©ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼Œæˆ‘ä¼šå°½åŠ›å¸®åŠ©æ‚¨ã€‚


ä¸ºäº†æ–¹ä¾¿å‘é€æ–°æ¶ˆæ¯ï¼Œå°è£…ä¸ªå‡½æ•°ã€‚



```python
def create_message_and_run(content, thread):
    """åˆ›å»ºæ¶ˆæ¯å¹¶æ‰§è¡Œ"""
    client.beta.threads.messages.create(
        thread_id=thread.id,
        role="user",
        content=content,
    )
    run = client.beta.threads.runs.create(
        assistant_id=assistant_id,
        thread_id=thread.id,
    )
    return run
```


```python
# å‘ä¸ª Code Interpreter è¯·æ±‚

run = create_message_and_run("ç”¨ä»£ç è®¡ç®— 1234567 çš„å¹³æ–¹æ ¹", thread)
run, result = wait_on_run(run, thread)
print(result)
```

    status: queued
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: completed
    {
        "tool_calls": [
            {
                "id": "call_IvBMLuEg0iq17t2rwn1VByuW",
                "code_interpreter": {
                    "input": "import math\n\n# Calculate the square root of 1234567\nsqrt_1234567 = math.sqrt(1234567)\nsqrt_1234567",
                    "outputs": [
                        {
                            "logs": "1111.1107055554814",
                            "type": "logs"
                        }
                    ]
                },
                "type": "code_interpreter"
            }
        ],
        "type": "tool_calls"
    }
    æ•°å­— \(1234567\) çš„å¹³æ–¹æ ¹å¤§çº¦æ˜¯ \(1111.1107\)ã€‚



```python
# å‘ä¸ª Function Calling è¯·æ±‚

# å®šä¹‰æœ¬åœ°å‡½æ•°å’Œæ•°æ®åº“

import sqlite3

# åˆ›å»ºæ•°æ®åº“è¿æ¥
conn = sqlite3.connect(':memory:')
cursor = conn.cursor()

# åˆ›å»ºordersè¡¨
cursor.execute("""
CREATE TABLE orders (
    id INT PRIMARY KEY NOT NULL, -- ä¸»é”®ï¼Œä¸å…è®¸ä¸ºç©º
    customer_id INT NOT NULL, -- å®¢æˆ·IDï¼Œä¸å…è®¸ä¸ºç©º
    product_id STR NOT NULL, -- äº§å“IDï¼Œä¸å…è®¸ä¸ºç©º
    price DECIMAL(10,2) NOT NULL, -- ä»·æ ¼ï¼Œä¸å…è®¸ä¸ºç©º
    status INT NOT NULL, -- è®¢å•çŠ¶æ€ï¼Œæ•´æ•°ç±»å‹ï¼Œä¸å…è®¸ä¸ºç©ºã€‚0ä»£è¡¨å¾…æ”¯ä»˜ï¼Œ1ä»£è¡¨å·²æ”¯ä»˜ï¼Œ2ä»£è¡¨å·²é€€æ¬¾
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- åˆ›å»ºæ—¶é—´ï¼Œé»˜è®¤ä¸ºå½“å‰æ—¶é—´ï¼Œæ ¼å¼ä¸º'YYYY-MM-DD HH:MM:SS'
    pay_time TIMESTAMP -- æ”¯ä»˜æ—¶é—´ï¼Œå¯ä»¥ä¸ºç©ºï¼Œæ ¼å¼ä¸º'YYYY-MM-DD HH:MM:SS'
);
""")

# æ’å…¥5æ¡æ˜ç¡®çš„æ¨¡æ‹Ÿè®°å½•
mock_data = [
    (1, 1001, 'TSHIRT_1', 50.00, 0, '2023-10-12 10:00:00', None),
    (2, 1001, 'TSHIRT_2', 75.50, 1, '2023-10-16 11:00:00', '2023-08-16 12:00:00'),
    (3, 1002, 'SHOES_X2', 25.25, 2, '2023-10-17 12:30:00', '2023-08-17 13:00:00'),
    (4, 1003, 'HAT_Z112', 60.75, 1, '2023-10-20 14:00:00', '2023-08-20 15:00:00'),
    (5, 1002, 'WATCH_X001', 90.00, 0, '2023-10-28 16:00:00', None)
]

for record in mock_data:
    cursor.execute('''
    INSERT INTO orders (id, customer_id, product_id, price, status, create_time, pay_time)
    VALUES (?, ?, ?, ?, ?, ?, ?)
    ''', record)

# æäº¤äº‹åŠ¡
conn.commit()


def ask_database(arguments):
    cursor.execute(arguments["query"])
    records = cursor.fetchall()
    return records


# å¯ä»¥è¢«å›è°ƒçš„å‡½æ•°æ”¾å…¥æ­¤å­—å…¸
available_functions = {
    "ask_database": ask_database,
}

run = create_message_and_run("å…¨éƒ¨å‡€æ”¶å…¥æœ‰å¤šå°‘ï¼Ÿ", thread)
run, result = wait_on_run(run, thread)
print(result)
```

    status: queued
    status: in_progress
    status: requires_action
    è°ƒç”¨å‡½æ•°ï¼šask_database()
    å‚æ•°ï¼š
    {"query":"SELECT SUM(price) FROM orders WHERE status = 1;"}
    ç»“æœï¼š[(136.25,)]
    status: queued
    status: in_progress
    status: completed
    {
        "tool_calls": [
            {
                "id": "call_SFnNYGyhVopuFLdv4A5RdbzZ",
                "function": {
                    "arguments": "{\"query\":\"SELECT SUM(price) FROM orders WHERE status = 1;\"}",
                    "name": "ask_database",
                    "output": "[[136.25]]"
                },
                "type": "function"
            }
        ],
        "type": "tool_calls"
    }
    å…¨éƒ¨å‡€æ”¶å…¥ä¸º 136.25 å…ƒã€‚


### ä¸¤ä¸ªæ— ä¾èµ–çš„ function ä¼šåœ¨ä¸€æ¬¡è¯·æ±‚ä¸­ä¸€èµ·è¢«è°ƒç”¨


```python
run = create_message_and_run("å…¨éƒ¨å‡€æ”¶å…¥æœ‰å¤šå°‘ï¼Ÿé€€æ¬¾æ€»é¢å¤šå°‘ï¼Ÿ", thread)
run, result = wait_on_run(run, thread)
print(result)
```

    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: requires_action
    è°ƒç”¨å‡½æ•°ï¼šask_database()
    å‚æ•°ï¼š
    {"query": "SELECT SUM(price) FROM orders WHERE status = 1;"}
    ç»“æœï¼š[(136.25,)]
    è°ƒç”¨å‡½æ•°ï¼šask_database()
    å‚æ•°ï¼š
    {"query": "SELECT SUM(price) FROM orders WHERE status = 2;"}
    ç»“æœï¼š[(25.25,)]
    status: queued
    status: in_progress
    status: completed
    {
        "tool_calls": [
            {
                "id": "call_3T0Bjd5ZzJJvBS5vXF49JVas",
                "function": {
                    "arguments": "{\"query\": \"SELECT SUM(price) FROM orders WHERE status = 1;\"}",
                    "name": "ask_database",
                    "output": "[[136.25]]"
                },
                "type": "function"
            },
            {
                "id": "call_rRYY41X4kplx7W9A3qsc2dJb",
                "function": {
                    "arguments": "{\"query\": \"SELECT SUM(price) FROM orders WHERE status = 2;\"}",
                    "name": "ask_database",
                    "output": "[[25.25]]"
                },
                "type": "function"
            }
        ],
        "type": "tool_calls"
    }
    å…¨éƒ¨å‡€æ”¶å…¥ä¸º 136.25 å…ƒï¼Œé€€æ¬¾æ€»é¢ä¸º 25.25 å…ƒã€‚



```python
# è¯•è¯• RAG è¯·æ±‚

run = create_message_and_run(
    "Llama2æœ‰å¤šå®‰å…¨", thread)
run, result = wait_on_run(run, thread)
print(result)
```

    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: in_progress
    status: completed
    {
        "tool_calls": [
            {
                "id": "call_wnPidU61p9k9tkgzMdQZ7kLS",
                "retrieval": {},
                "type": "retrieval"
            }
        ],
        "type": "tool_calls"
    }
    Llama2æ˜¯ä¸€ä¸ªæ–°æŠ€æœ¯ï¼Œå®ƒå¸¦æ¥äº†æ½œåœ¨çš„ä½¿ç”¨é£é™©ã€‚åˆ°ç›®å‰ä¸ºæ­¢è¿›è¡Œçš„æµ‹è¯•ä»…é€‚ç”¨äºè‹±è¯­ï¼Œå¹¶ä¸”æ²¡æœ‰ä¹Ÿæ— æ³•æ¶µç›–æ‰€æœ‰åœºæ™¯ã€‚å› æ­¤ï¼Œåœ¨éƒ¨ç½²ä½¿ç”¨Llama 2çš„ä»»ä½•åº”ç”¨ç¨‹åºä¹‹å‰ï¼Œå¼€å‘è€…åº”è¯¥è¿›è¡Œé’ˆå¯¹ä»–ä»¬ç‰¹å®šåº”ç”¨çš„æ¨¡å‹çš„å®‰å…¨æµ‹è¯•å’Œè°ƒæ•´ã€‚ä¸ºäº†ä¾¿äºLlama 2å’ŒLlama 2-Chatçš„å®‰å…¨éƒ¨ç½²ï¼Œæä¾›äº†è´Ÿè´£ä»»çš„ä½¿ç”¨æŒ‡å—å’Œä»£ç ç¤ºä¾‹ã€‚å…³äºè´Ÿè´£ä»»å‘å¸ƒç­–ç•¥çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯å¯ä»¥åœ¨æ–‡æ¡£çš„ç¬¬5.3èŠ‚æ‰¾åˆ°ã€‚


## æ€»ç»“

![](https://cdn.openai.com/API/docs/images/diagram-assistant.webp)


## å…¶å®ƒ

å°çŸ¥è¯†ç‚¹ï¼š

1. Annotations è·å–å‚è€ƒèµ„æ–™åœ°å€ï¼šhttps://platform.openai.com/docs/assistants/how-it-works/managing-threads-and-messages
2. æ–‡ä»¶ç®¡ç† APIï¼šhttps://platform.openai.com/docs/api-reference/assistants/file-object
3. åˆ›å»º thread æ—¶ç«‹å³æ‰§è¡Œï¼šhttps://platform.openai.com/docs/api-reference/runs/createThreadAndRun

å®˜æ–¹æ–‡æ¡£ï¼š

1. Guide: https://platform.openai.com/docs/assistants/overview
2. Cookbook: https://cookbook.openai.com/examples/assistants_api_overview_python
3. API Reference: https://platform.openai.com/docs/api-reference/assistants



```python

```
